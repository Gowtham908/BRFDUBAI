create or replace PROCEDURE         "BRF47A_MAPPING_PROCEDURE" (REPORT_DATE VARCHAR2)
 
IS
 
  V_REPORT_DATE DATE := To_date (REPORT_DATE, 'DD-MM-YYYY');

  -- V_FROM_DATE dATE :=  ADD_MONTHS (LAST_DAY (REPORT_DATE), -1) + 1;

BEGIN

delete from BRF47A_MAPPING_TABLE where report_date = v_report_date;

commit;


INSERT INTO BRF47A_MAPPING_TABLE
(CUST_ID,FORACID,ACCT_NAME,ACT_BALANCE_AMT_LC,ACCT_CRNCY_CODE,GL_CODE,GL_SUB_HEAD_CODE,SCHM_CODE,SCHM_TYPE,SOL_ID,
ACID,LEGAL_ENTITY_TYPE,CONSTITUTION_CODE,COUNTRY_OF_INCORP,REPORT_DATE)
 SELECT CUST_ID,ACCT_NUMBER,ACCT_NAME,ACT_BALANCE_AMT_LC,ACCT_CRNCY_CODE,GL_CODE,GL_SUB_HEAD_CODE,
SCHM_CODE,SCHM_TYPE,SOL_ID,ACID,LEGAL_ENTITY_TYPE,CONSTITUTION_CODE,COUNTRY_OF_INCORP,REPORT_DATE
FROM GENERAL_MASTER_TABLE where report_date =v_report_date and SCHM_CODE ='LA008' AND 
SOL_ID in ('9001','9002','9003','9004','9005');


INSERT INTO BRF47A_MAPPING_TABLE
(CUST_ID,FORACID,ACCT_NAME,ACT_BALANCE_AMT_LC,ACCT_CRNCY_CODE,GL_CODE,GL_SUB_HEAD_CODE,SCHM_CODE,SCHM_TYPE,SOL_ID,
ACID,LEGAL_ENTITY_TYPE,CONSTITUTION_CODE,COUNTRY_OF_INCORP,REPORT_DATE)
 SELECT CUST_ID,ACCT_NUMBER,ACCT_NAME,ACT_BALANCE_AMT_LC,ACCT_CRNCY_CODE,GL_CODE,GL_SUB_HEAD_CODE,
SCHM_CODE,SCHM_TYPE,SOL_ID,ACID,LEGAL_ENTITY_TYPE,CONSTITUTION_CODE,COUNTRY_OF_INCORP,REPORT_DATE
FROM GENERAL_MASTER_TABLE where report_date =v_report_date  and  SOL_ID ='9008' and 
CONSTITUTION_CODE  not in ('33101','11507','MBI');


COMMIT;
END;

create or replace PROCEDURE         "BRF47B_MAPPING_PROCEDURE" (REPORT_DATE DATE)
IS
   V_REPORT_DATE DATE := To_date (REPORT_DATE, 'DD-MM-YYYY'); 

BEGIN
delete from BRF47B_MAPPING_TABLE where report_date = v_report_date;
Commit;

MERGE INTO BRF47B_MAPPING_TABLE b
    USING (
        SELECT 
            ACCT_NAME,COUNTRY_OF_INCORP,LEGAL_ENTITY_TYPE,
            LISTAGG(FORACID, ', ') WITHIN GROUP (ORDER BY FORACID) AS AccountNumbers,
            (SELECT SUM(ACT_BALANCE_AMT_LC) FROM BRF47A_MAPPING_TABLE WHERE ACCT_NAME = a.ACCT_NAME) AS TotalBalance
        FROM 
            BRF47A_MAPPING_TABLE a
        GROUP BY 
          ACCT_NAME,COUNTRY_OF_INCORP,LEGAL_ENTITY_TYPE
    ) a ON (b.ACCT_NAME = a.ACCT_NAME AND b.REPORT_DATE = '30-JUN-2023')
    WHEN MATCHED THEN
        UPDATE SET 
                   b.FORACID = a.AccountNumbers,
                   b.ACT_BALANCE_AMT_LC = a.TotalBalance,
                   b.COUNTRY_OF_INCORP = a.COUNTRY_OF_INCORP,
                   b.LEGAL_ENTITY_TYPE = a.LEGAL_ENTITY_TYPE

    WHEN NOT MATCHED THEN
        INSERT ( ACCT_NAME, FORACID, ACT_BALANCE_AMT_LC, REPORT_DATE,COUNTRY_OF_INCORP,LEGAL_ENTITY_TYPE)
        VALUES ( a.ACCT_NAME, a.AccountNumbers, a.TotalBalance, '30-JUN-2023',a.COUNTRY_OF_INCORP,a.LEGAL_ENTITY_TYPE);




UPDATE BRF47B_MAPPING_TABLE
SET REPORT_NAME_1 = 'BRF47', REPORT_ADDL_CRITERIA_1 = 
    CASE
        WHEN COUNTRY_OF_INCORP = 'AE' THEN 'UAE'
        ELSE 'Non-UAE'
    END;     

UPDATE BRF47B_MAPPING_TABLE
SET  REPORT_NAME_1 = 'BRF47', REPORT_ADDL_CRITERIA_2 = 
    CASE
        WHEN LEGAL_ENTITY_TYPE IN ('PVTCO', 'OTH', 'FORSV', 'BUSIN', 'WT', 'SERV', 'HOTEL', 'MNC') THEN 'CORPORATE'
        WHEN LEGAL_ENTITY_TYPE IN ('FGBBK', 'NBFC') THEN 'NBFI'
        WHEN LEGAL_ENTITY_TYPE IN ('GOVTE', 'GOVTF') THEN 'Government AND NCE'
        WHEN LEGAL_ENTITY_TYPE IN ('PSEC','PSENO') THEN 'GRE'
    END;


 --NOTE:
--REPORT_ADDL_CRITERIA_1 -  Country of risk (CELL)
--REPORT_ADDL_CRITERIA_2 -  Counterparty type (CELL)






COMMIT;
END;

create or replace PROCEDURE         "BRF47A_DETAIL_PROCEDURE" (REPORT_DATE DATE)
IS
  V_REPORT_DATE DATE := To_date (REPORT_DATE, 'DD-MM-YYYY'); 

BEGIN


delete from BRF47A_DETAILTABLE where REPORT_DATE = V_REPORT_DATE;
Commit;


insert into BRF47A_DETAILTABLE
( foracid, cust_id, ACCT_NAME,REPORT_DATE,ACT_BALANCE_AMT_LC,REPORT_LABEL_1,REPORT_NAME_1,REPORT_ADDL_CRITERIA_1)
SELECT  foracid, cust_id, ACCT_NAME,REPORT_DATE,ACT_BALANCE_AMT_LC,REPORT_LABEL_1,REPORT_NAME_1,REPORT_ADDL_CRITERIA_1 FROM 
brf47A_mapping_table where REPORT_DATE = V_REPORT_DATE  ;


COMMIT;
END;

create or replace PROCEDURE         "BRF47B_DETAIL_PROCEDURE" (REPORT_DATE DATE)
IS
  V_REPORT_DATE DATE := To_date (REPORT_DATE, 'DD-MM-YYYY'); 

BEGIN


delete from BRF47B_DETAILTABLE where REPORT_DATE = V_REPORT_DATE;
Commit;


insert into BRF47B_DETAILTABLE
( foracid, cust_id, ACCT_NAME,REPORT_DATE,ACT_BALANCE_AMT_LC,REPORT_LABEL_1,REPORT_NAME_1,REPORT_ADDL_CRITERIA_1,REPORT_ADDL_CRITERIA_2)
SELECT  foracid, cust_id, ACCT_NAME,REPORT_DATE,ACT_BALANCE_AMT_LC,REPORT_LABEL_1,REPORT_NAME_1,REPORT_ADDL_CRITERIA_1,REPORT_ADDL_CRITERIA_2 FROM 
brf47B_mapping_table where REPORT_DATE = V_REPORT_DATE  ;


COMMIT;
END;

create or replace PROCEDURE         "BRF47_SUMMARY_PROCEDURE" (REPORT_DATE VARCHAR2)
 
IS
  v_count NUMBER;
  V_REPORT_DATE DATE := To_date (REPORT_DATE, 'DD-MM-YYYY');

  -- V_FROM_DATE dATE :=  ADD_MONTHS (LAST_DAY (REPORT_DATE), -1) + 1;

BEGIN

delete from BRF47_SUMMARYTABLE where report_date = v_report_date;

commit;

--INSERT 
FOR SUMMARY IN (SELECT ACCT_NAME, REPORT_ADDL_CRITERIA_1,REPORT_ADDL_CRITERIA_2,ACT_BALANCE_AMT_LC,REPORT_DATE
FROM BRF47B_DETAILTABLE  where report_date = v_report_date AND REPORT_ADDL_CRITERIA_1 IS NOT NULL AND
REPORT_ADDL_CRITERIA_2 IS NOT NULL )
  LOOP
    -- Insert values into the target table
    INSERT INTO BRF47_SUMMARYTABLE (ISSUE_NAME,COUNTRY,COUNTRY_PARTY,AMOUNT,REPORT_DATE)
    VALUES (SUMMARY.ACCT_NAME, SUMMARY.REPORT_ADDL_CRITERIA_1,SUMMARY.REPORT_ADDL_CRITERIA_2,SUMMARY.ACT_BALANCE_AMT_LC,
    SUMMARY.REPORT_DATE);
END LOOP;

--UPDATE 
UPDATE BRF47_SUMMARYTABLE
SET GRANT_TOTAL = (SELECT  round(nvl(sum(abs(AMOUNT))/1000,0)) FROM BRF47_SUMMARYTABLE);

UPDATE BRF47_SUMMARYTABLE
SET AMOUNT = abs(AMOUNT)/1000;
COMMIT;
END;

